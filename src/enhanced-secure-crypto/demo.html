<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Secure Crypto Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status-panel {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .status-ready { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .status-loading { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .status-error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .section {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        textarea, input { padding: 8px; border-radius: 3px; border: 1px solid #ccc; }
        .encrypted-box { background-color: #f8f9fa; font-family: monospace; font-size: 12px; }
        .success-box { background-color: #d4edda; padding: 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>🔐 Enhanced Secure Crypto Demo (Rust + WASM)</h1>
    
    <div id="status" class="status-panel status-loading">
        <h3>Status</h3>
        <p id="status-text">Initializing...</p>
        <p id="crypto-ready">Crypto Ready: ⏳ Loading...</p>
    </div>

    <div id="demo-content" style="display: none;">
        <!-- Password Section -->
        <div class="section">
            <h3>🔑 Password Management</h3>
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="password" placeholder="Encryption password" style="flex: 1;">
                <button onclick="generateNewPassword()">Generate New</button>
            </div>
            <button onclick="generateVerificationCode()">Generate Verification Code</button>
        </div>

        <!-- Message Section -->
        <div class="section">
            <h3>💬 Message Operations</h3>
            <textarea id="message" placeholder="Enter your message here..." rows="4" style="width: 100%; margin-bottom: 10px;">Hello, secure world! 🔐</textarea>
            <div>
                <button onclick="encryptMessage()">🔒 Encrypt</button>
                <button onclick="signMessage()">✍️ Sign</button>
                <button onclick="verifySignature()">🔍 Verify Signature</button>
            </div>
        </div>

        <!-- Encrypted Message Section -->
        <div id="encrypted-section" class="section" style="display: none;">
            <h3>🔐 Encrypted Message</h3>
            <textarea id="encrypted-message" readonly rows="4" style="width: 100%; margin-bottom: 10px;" class="encrypted-box"></textarea>
            <button onclick="decryptMessage()">🔓 Decrypt</button>
        </div>

        <!-- Decrypted Message Section -->
        <div id="decrypted-section" class="section" style="display: none;">
            <h3>📄 Decrypted Message</h3>
            <div id="decrypted-message" class="success-box"></div>
        </div>

        <!-- Signature Section -->
        <div id="signature-section" class="section" style="display: none;">
            <h3>✍️ Digital Signature</h3>
            <textarea id="signature" readonly rows="2" style="width: 100%;" class="encrypted-box"></textarea>
        </div>

        <!-- Security Info -->
        <div class="section" style="background-color: #d1ecf1; border-color: #bee5eb;">
            <h3>🛡️ Security Information</h3>
            <ul>
                <li><strong>Encryption:</strong> AES-256-GCM (256-bit key)</li>
                <li><strong>Key Derivation:</strong> PBKDF2-HMAC-SHA256 (100,000 iterations)</li>
                <li><strong>Digital Signatures:</strong> ECDSA P-384 with SHA-384</li>
                <li><strong>Random Generation:</strong> Cryptographically secure PRNG</li>
                <li><strong>Memory Safety:</strong> Rust + WebAssembly</li>
                <li><strong>Performance:</strong> ~5-7x faster than pure JavaScript</li>
            </ul>
        </div>
    </div>

    <!-- ВАЖНО: используем type="module" для ES6 импортов -->
    <script type="module">
        // Импортируем WASM модуль как ES6 модуль
        import init, { EnhancedSecureCryptoUtils } from './pkg/enhanced_secure_crypto.js';

        let crypto = null;
        let keyPair = null;
        let isReady = false;

        // Функции обновления статуса
        function updateStatus(text, type = 'loading') {
            document.getElementById('status-text').textContent = text;
            document.getElementById('status').className = `status-panel status-${type}`;
        }

        function updateCryptoReady(ready) {
            document.getElementById('crypto-ready').textContent = `Crypto Ready: ${ready ? '✅ Yes' : '⏳ Loading...'}`;
            document.getElementById('demo-content').style.display = ready ? 'block' : 'none';
        }

        // Инициализация WASM модуля
        async function initializeCrypto() {
            try {
                updateStatus('Loading WASM module...', 'loading');
                
                // Инициализируем WASM
                await init();
                
                updateStatus('Creating crypto instance...', 'loading');
                
                // Создаем экземпляр
                crypto = new EnhancedSecureCryptoUtils();
                
                updateStatus('Generating secure password...', 'loading');
                const password = crypto.generate_secure_password();
                document.getElementById('password').value = password;
                
                updateStatus('Generating key pair...', 'loading');
                keyPair = crypto.generate_ecdsa_keypair();
                
                isReady = true;
                updateStatus('✅ Rust crypto module ready!', 'ready');
                updateCryptoReady(true);
                
            } catch (error) {
                console.error('Crypto initialization failed:', error);
                updateStatus(`❌ Failed: ${error.message}`, 'error');
                updateCryptoReady(false);
            }
        }

        // Глобальные функции (делаем их доступными из HTML)
        window.generateNewPassword = function() {
            if (!crypto) return;
            const newPassword = crypto.generate_secure_password();
            document.getElementById('password').value = newPassword;
            updateStatus('🔑 New password generated', 'ready');
        };

        window.generateVerificationCode = function() {
            if (!crypto) return;
            const code = crypto.generate_verification_code();
            updateStatus(`🔢 Verification code: ${code}`, 'ready');
        };

        window.encryptMessage = function() {
            if (!crypto) return;
            
            const message = document.getElementById('message').value;
            const password = document.getElementById('password').value;
            
            if (!message.trim()) {
                updateStatus('❌ Please enter a message', 'error');
                return;
            }

            try {
                updateStatus('🔒 Encrypting message...', 'loading');
                const sanitized = crypto.sanitize_message(message);
                const encrypted = crypto.encrypt_data(sanitized, password);
                
                document.getElementById('encrypted-message').value = encrypted;
                document.getElementById('encrypted-section').style.display = 'block';
                updateStatus('✅ Message encrypted successfully', 'ready');
            } catch (error) {
                updateStatus(`❌ Encryption failed: ${error.message}`, 'error');
            }
        };

        window.decryptMessage = function() {
            if (!crypto) return;
            
            const encryptedMessage = document.getElementById('encrypted-message').value;
            const password = document.getElementById('password').value;
            
            if (!encryptedMessage.trim()) {
                updateStatus('❌ No encrypted message to decrypt', 'error');
                return;
            }

            try {
                updateStatus('🔓 Decrypting message...', 'loading');
                const decrypted = crypto.decrypt_data(encryptedMessage, password);
                
                document.getElementById('decrypted-message').textContent = decrypted;
                document.getElementById('decrypted-section').style.display = 'block';
                updateStatus('✅ Message decrypted successfully', 'ready');
            } catch (error) {
                updateStatus(`❌ Decryption failed: ${error.message}`, 'error');
            }
        };

        window.signMessage = function() {
            if (!crypto || !keyPair) return;
            
            const message = document.getElementById('message').value;
            
            if (!message.trim()) {
                updateStatus('❌ Please enter a message to sign', 'error');
                return;
            }

            try {
                updateStatus('✍️ Signing message...', 'loading');
                const signatureBytes = crypto.sign_data(keyPair.private_key, message);
                const signatureHex = Array.from(signatureBytes)
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
                
                document.getElementById('signature').value = signatureHex;
                document.getElementById('signature-section').style.display = 'block';
                updateStatus('✅ Message signed successfully', 'ready');
            } catch (error) {
                updateStatus(`❌ Signing failed: ${error.message}`, 'error');
            }
        };

        window.verifySignature = function() {
            if (!crypto || !keyPair) return;
            
            const message = document.getElementById('message').value;
            const signatureHex = document.getElementById('signature').value;
            
            if (!message.trim() || !signatureHex.trim()) {
                updateStatus('❌ Need message and signature to verify', 'error');
                return;
            }

            try {
                updateStatus('🔍 Verifying signature...', 'loading');
                const signatureBytes = signatureHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16));
                const isValid = crypto.verify_signature(keyPair.public_key, signatureBytes, message);
                updateStatus(isValid ? '✅ Signature is valid' : '❌ Signature is invalid', isValid ? 'ready' : 'error');
            } catch (error) {
                updateStatus(`❌ Verification failed: ${error.message}`, 'error');
            }
        };

        // Запуск инициализации
        initializeCrypto();
    </script>
</body>
</html>